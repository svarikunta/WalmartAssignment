package com.walmart.test;



import java.util.ArrayList;
import java.util.List;

import org.junit.Assert;
import org.junit.Test;

import com.wallmart.service.TicketingService;
import com.wallmart.service.TicketingServiceImpl;
import com.wallmat.model.Custmore;
import com.wallmat.model.FindAvailableResponse;
import com.wallmat.model.ReserveAndCommitRequest;
import com.wallmat.model.ReserveAndCommitResponse;
import com.wallmat.model.FindAndHoldRequest;
import com.wallmat.model.FindAndHoldResponse;
import com.wallmat.model.Seat;
import com.walmart.Constats.Constants;


public class TestReserveAndCommit {
	
	TicketingService ts= new TicketingServiceImpl();


	
	@Test
	public void testHoldSeats(){
		
		FindAndHoldRequest request= new FindAndHoldRequest();
		
		FindAndHoldResponse response=null;

		FindAvailableResponse before=null;
		FindAvailableResponse after=null;
		
		Custmore cust = new Custmore("Sam",479569349);
		request.setCustmore(cust);
		List<Seat> custPreferdSeats= new ArrayList<Seat>();
		Seat st1 = new Seat('B', 2);
		custPreferdSeats.add(st1);
		Seat st2 = new Seat('C', 2);
		custPreferdSeats.add(st2);
		Seat st3 = new Seat('D', 2);
		custPreferdSeats.add(st3);
		Seat st4 = new Seat('E', 2);
		custPreferdSeats.add(st4);
		Seat st5 = new Seat('F', 2);
		custPreferdSeats.add(st5);
		request.setCustPreferdSeats(custPreferdSeats);
		ts.displayStage();
		
		before=ts.findNoOfSeatsAvilable();
		
		response=ts.holdSeats(request);
		
		after=ts.findNoOfSeatsAvilable();
		
		
		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);
		Assert.assertEquals(before.getTotalAvailableSeats()-custPreferdSeats.size(),after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats()+custPreferdSeats.size(),after.getTotalHeldSeats());
		Assert.assertTrue(compareReqestedAndHeldSeats(request.getCustPreferdSeats(),response.getSeatsHeld()));
		
		ts.displayStage();
		
		ReserveAndCommitRequest  reserveAndCommitRequest= new ReserveAndCommitRequest();
		reserveAndCommitRequest.setSeatsHeld(response.getSeatsHeld());
		reserveAndCommitRequest.setCustmore(cust);
		
		before=ts.findNoOfSeatsAvilable();
		
		ReserveAndCommitResponse reserveAndCommitResponse=ts.reserveAndCommitSeats(reserveAndCommitRequest);
		
		after=ts.findNoOfSeatsAvilable();
		
		Assert.assertNotNull(reserveAndCommitResponse);
		Assert.assertEquals(reserveAndCommitResponse.getStatus(), ReserveAndCommitResponse.Status.Sucess);
		
		Assert.assertEquals(before.getTotalAvailableSeats(),after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats()-reserveAndCommitRequest.getSeatsHeld().size(),after.getTotalHeldSeats());
		Assert.assertEquals(before.getTotalReservedSeats()+reserveAndCommitRequest.getSeatsHeld().size(),after.getTotalReservedSeats());
		
		ts.displayStage();

	}
	
		
	@Test
	public void TestHoldSeatTimer() {
		
		
		FindAndHoldRequest request= new FindAndHoldRequest();
		FindAndHoldResponse response = null;
		
		FindAvailableResponse before=null;
		FindAvailableResponse after=null;
		
		Custmore cust = new Custmore("Harry",234345678);
		request.setCustmore(cust);
		request.setReqNumbOfSeats(5);
		request.setCustPreferedRow('B');
		ts.displayStage();
		
		before=ts.findNoOfSeatsAvilable();
		response=ts.findAndHoldSeats(request);
		after=ts.findNoOfSeatsAvilable();
	
		ts.displayStage();
		
		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);
		Assert.assertEquals(before.getTotalAvailableSeats(),after.getTotalAvailableSeats()+request.getReqNumbOfSeats());
		Assert.assertEquals(before.getTotalHeldSeats()+request.getReqNumbOfSeats(),after.getTotalHeldSeats());
	
		
		try {
			Thread.sleep(Constants.HOLD_TIME+1000);
		} catch (InterruptedException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		ReserveAndCommitRequest  reserveAndCommitRequest= new ReserveAndCommitRequest();
		reserveAndCommitRequest.setSeatsHeld(response.getSeatsHeld());
		reserveAndCommitRequest.setCustmore(cust);
		ReserveAndCommitResponse reserveAndCommitResponse=ts.reserveAndCommitSeats(reserveAndCommitRequest);
		after=ts.findNoOfSeatsAvilable();
		Assert.assertNotNull(reserveAndCommitResponse);
		Assert.assertEquals(before.getTotalAvailableSeats(),after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats(),after.getTotalHeldSeats());
		ts.displayStage();
		//System.out.println(Stage.seatsAvilable.get());
	}
	
	private boolean compareReqestedAndHeldSeats(List<Seat> requestedSeats, List<Seat> heldSeats){
		
		
		for(Seat heldSt:heldSeats){
			
			if(!contains(requestedSeats,heldSt)){
				return false;
			}
			
		}
		return true;
		
	}
	
	private boolean contains(List<Seat> requestedSeats, Seat heldSt){
		
		
        for(Seat reqSt:requestedSeats){
        	
        	if(reqSt.getColNo()==heldSt.getColNo() && reqSt.getRowNo().equals(heldSt.getRowNo()) )
        		return true;
			
		}
		
		return false;
		
	}

}
