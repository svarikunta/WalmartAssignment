package com.walmart.test;

import org.junit.Assert;
import org.junit.Test;
import com.wallmart.service.TicketingService;
import com.wallmart.service.TicketingServiceImpl;
import com.wallmat.model.Custmore;
import com.wallmat.model.FindAvailableResponse;
import com.wallmat.model.ReserveAndCommitRequest;
import com.wallmat.model.ReserveAndCommitResponse;
import com.wallmat.model.FindAndHoldRequest;
import com.wallmat.model.FindAndHoldResponse;
import com.walmart.Constats.Constants;

public class TestFindAndHoldSeats {

	TicketingService ts = new TicketingServiceImpl();

	@Test
	public void testHoldSeats() {

		FindAndHoldRequest request = new FindAndHoldRequest();

		FindAndHoldResponse response = null;

		FindAvailableResponse before = null;
		FindAvailableResponse after = null;

		Custmore cust = new Custmore("charly", 479569349);
		request.setCustmore(cust);
		request.setReqNumbOfSeats(4);
		request.setCustPreferedRow('G');

		ts.displaySeatMap();

		before = ts.findNoOfSeatsAvilable();

		response = ts.findAndHoldSeats(request);

		after = ts.findNoOfSeatsAvilable();

		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);
		Assert.assertEquals(before.getTotalAvailableSeats() - request.getReqNumbOfSeats(),
				after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats() + request.getReqNumbOfSeats(), after.getTotalHeldSeats());
		// Assert.assertTrue(compareReqestedAndHeldSeats(request.getCustPreferdSeats(),response.getSeatsHeld()));

		ts.displaySeatMap();

		ReserveAndCommitRequest reserveAndCommitRequest = new ReserveAndCommitRequest();
		reserveAndCommitRequest.setSeatsHeld(response.getSeatsHeld());
		reserveAndCommitRequest.setCustmore(cust);

		before = ts.findNoOfSeatsAvilable();

		ReserveAndCommitResponse reserveAndCommitResponse = ts.reserveAndCommitSeats(reserveAndCommitRequest);

		after = ts.findNoOfSeatsAvilable();

		Assert.assertNotNull(reserveAndCommitResponse);
		Assert.assertEquals(reserveAndCommitResponse.getStatus(), ReserveAndCommitResponse.Status.Sucess);

		Assert.assertEquals(before.getTotalAvailableSeats(), after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats() - reserveAndCommitRequest.getSeatsHeld().size(),
				after.getTotalHeldSeats());
		Assert.assertEquals(before.getTotalReservedSeats() + reserveAndCommitRequest.getSeatsHeld().size(),
				after.getTotalReservedSeats());

		ts.displaySeatMap();

	}

	@Test
	public void testHoldSeatsSplitRow() {

		FindAndHoldRequest request = new FindAndHoldRequest();

		FindAndHoldResponse response = null;

		FindAvailableResponse before = null;
		FindAvailableResponse after = null;

		Custmore cust = new Custmore("charly", 479569349);
		request.setCustmore(cust);
		request.setReqNumbOfSeats(8);
		request.setCustPreferedRow('G');

		ts.displaySeatMap();

		before = ts.findNoOfSeatsAvilable();

		response = ts.findAndHoldSeats(request);

		after = ts.findNoOfSeatsAvilable();

		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);
		Assert.assertEquals(before.getTotalAvailableSeats() - request.getReqNumbOfSeats(),
				after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats() + request.getReqNumbOfSeats(), after.getTotalHeldSeats());
		// Assert.assertTrue(compareReqestedAndHeldSeats(request.getCustPreferdSeats(),response.getSeatsHeld()));

		ts.displaySeatMap();

		ReserveAndCommitRequest reserveAndCommitRequest = new ReserveAndCommitRequest();
		reserveAndCommitRequest.setSeatsHeld(response.getSeatsHeld());
		reserveAndCommitRequest.setCustmore(cust);

		before = ts.findNoOfSeatsAvilable();

		ReserveAndCommitResponse reserveAndCommitResponse = ts.reserveAndCommitSeats(reserveAndCommitRequest);

		after = ts.findNoOfSeatsAvilable();

		Assert.assertNotNull(reserveAndCommitResponse);
		Assert.assertEquals(reserveAndCommitResponse.getStatus(), ReserveAndCommitResponse.Status.Sucess);

		Assert.assertEquals(before.getTotalAvailableSeats(), after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats() - reserveAndCommitRequest.getSeatsHeld().size(),
				after.getTotalHeldSeats());
		Assert.assertEquals(before.getTotalReservedSeats() + reserveAndCommitRequest.getSeatsHeld().size(),
				after.getTotalReservedSeats());

		Custmore cust2 = new Custmore("David", 345345663);
		request.setCustmore(cust2);
		request.setReqNumbOfSeats(8);
		request.setCustPreferedRow('G');

		response = ts.findAndHoldSeats(request);

		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.NeedConfirm);
		request.setCustPreferdSeats(response.getBestAvilableSeats());
		response = ts.holdSeats(request);

		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);

		ts.displaySeatMap();

	}

	@Test
	public void testHoldSeatsBestAvailable() {

		FindAndHoldRequest request = new FindAndHoldRequest();

		FindAndHoldResponse response = null;

		FindAvailableResponse before = null;
		FindAvailableResponse after = null;

		Custmore cust = new Custmore("name1", 479569329);
		request.setCustmore(cust);
		request.setReqNumbOfSeats(4);

		ts.displaySeatMap();

		before = ts.findNoOfSeatsAvilable();

		response = ts.findAndHoldSeats(request);

		after = ts.findNoOfSeatsAvilable();

		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);
		Assert.assertEquals(before.getTotalAvailableSeats() - request.getReqNumbOfSeats(),
				after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats() + request.getReqNumbOfSeats(), after.getTotalHeldSeats());
		// Assert.assertTrue(compareReqestedAndHeldSeats(request.getCustPreferdSeats(),response.getSeatsHeld()));

		ts.displaySeatMap();

		ReserveAndCommitRequest reserveAndCommitRequest = new ReserveAndCommitRequest();
		reserveAndCommitRequest.setSeatsHeld(response.getSeatsHeld());
		reserveAndCommitRequest.setCustmore(cust);

		before = ts.findNoOfSeatsAvilable();

		ReserveAndCommitResponse reserveAndCommitResponse = ts.reserveAndCommitSeats(reserveAndCommitRequest);

		after = ts.findNoOfSeatsAvilable();

		Assert.assertNotNull(reserveAndCommitResponse);
		Assert.assertEquals(reserveAndCommitResponse.getStatus(), ReserveAndCommitResponse.Status.Sucess);

		Assert.assertEquals(before.getTotalAvailableSeats(), after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats() - reserveAndCommitRequest.getSeatsHeld().size(),
				after.getTotalHeldSeats());
		Assert.assertEquals(before.getTotalReservedSeats() + reserveAndCommitRequest.getSeatsHeld().size(),
				after.getTotalReservedSeats());

		ts.displaySeatMap();

	}

	@Test
	public void TestHoldSeatTimer() {

		FindAndHoldRequest request = new FindAndHoldRequest();
		FindAndHoldResponse response = null;

		FindAvailableResponse before = null;
		FindAvailableResponse after = null;

		Custmore cust = new Custmore("Harry", 234345678);
		request.setCustmore(cust);
		request.setReqNumbOfSeats(5);
		request.setCustPreferedRow('B');
		ts.displaySeatMap();

		before = ts.findNoOfSeatsAvilable();
		response = ts.findAndHoldSeats(request);
		after = ts.findNoOfSeatsAvilable();

		ts.displaySeatMap();

		Assert.assertNotNull(response);
		Assert.assertEquals(response.getStatus(), FindAndHoldResponse.Status.Sucess);
		Assert.assertEquals(before.getTotalAvailableSeats(),
				after.getTotalAvailableSeats() + request.getReqNumbOfSeats());
		Assert.assertEquals(before.getTotalHeldSeats() + request.getReqNumbOfSeats(), after.getTotalHeldSeats());

		try {
			Thread.sleep(Constants.HOLD_TIME + 1000);
		} catch (InterruptedException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}

		ReserveAndCommitRequest reserveAndCommitRequest = new ReserveAndCommitRequest();
		reserveAndCommitRequest.setSeatsHeld(response.getSeatsHeld());
		reserveAndCommitRequest.setCustmore(cust);
		ReserveAndCommitResponse reserveAndCommitResponse = ts.reserveAndCommitSeats(reserveAndCommitRequest);
		after = ts.findNoOfSeatsAvilable();
		Assert.assertNotNull(reserveAndCommitResponse);
		Assert.assertEquals(before.getTotalAvailableSeats(), after.getTotalAvailableSeats());
		Assert.assertEquals(before.getTotalHeldSeats(), after.getTotalHeldSeats());
		Assert.assertEquals(before.getTotalReservedSeats(), after.getTotalReservedSeats());
		ts.displaySeatMap();
		// System.out.println(Stage.seatsAvilable.get());
	}

}
